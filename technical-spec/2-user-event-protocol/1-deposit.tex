\documentclass[../midgard.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\section{Deposit (L1)}
\label{h:deposit}

A user deposits funds into Midgard by submitting an L1 transaction that performs the following:
\begin{enumerate}
    \item Spend an input \code{l1\_nonce}, which uniquely identifies this deposit transaction.
    \item Register a staking script credential to witness the deposit.
      The script is parametrized by \code{l2\_id} (which is Blake2b256 hash of \code{l1\_nonce}), and the credential's purpose is to disprove the existence of the deposit whenever the credential is \emph{not} registered.\footnote{Cardano's ledger lacks a more direct method to disprove the existence of a utxo to a Plutus script.}
    \item Total count of tokens in the deposit must not exceed \code{max\_transfer\_token\_count}, a Midgard protocol pararmeter.
    \item Mint a deposit auth token to verify the following datum:
        \begin{equation*}
        \T{DepositDatum} \coloneq \left\{
            \begin{array}{ll}
                \T{event} : & \T{DepositEvent}, \\
                \T{inclusion\_time} : & \T{PosixTime}, \\
                \T{witness} : & \T{ScriptHash}, \\
            \end{array}
            \right\}
        \end{equation*}
    \item Send the user's deposited funds to the Midgard deposit address, along with the deposit auth token and the above datum.
\end{enumerate}

At the time of the L1 deposit transaction, the deposit's \code{inclusion\_time} is set to the sum of the transaction's validity interval upper bound and the \code{event\_wait\_duration} Midgard protocol parameter.
According to Midgard's ledger rules:
\begin{description}
    \item[Deposit inclusion.] A block header must include deposit events with inclusion times falling within the block header's event interval, and it must \emph{not} include any other deposit events.
\end{description}

Furthermore, the state queue enforces that event intervals are adjacent and non-overlapping.
Therefore, while operators continue committing valid block headers, every deposit is eventually included in the state queue.

On the other hand, suppose a fraud proof is verified on L1 to prove that a block header in the state queue has violated the deposit inclusion rule.
When this block header and all its descendants are removed, the state queue enforces that the next committed block header's event interval must contain all of those removed block headers' event intervals.
Therefore, Midgard's ledger rules require this new block header to include all deposit events that should have been included in the removed block headers.

The deposit can be absorbed into the Midgard reserve whenever a settlement utxo is available such that its deposits tree contains the deposit event.

The deposit's \code{witness} staking credential must be deregistered when the deposit utxo is spent.

\subsection{Minting policy}
\label{h:deposit-minting-policy}

The \code{deposit} minting policy is statically parametrized on the \code{hub\_oracle} minting policy.
It oversees correctness of datums, and registration/unregistration of events' corresponding witness staking scripts.

\begin{description}
  \item[Authenticate Deposit.] Properly record a new deposit event from L1 to L2.
    Conditions:
      \begin{enumerate}
        \item Let \code{l1\_nonce} be the output reference of a utxo on L1 that is spent in the deposit transaction.
        \item Let \code{l2\_id} be the Blake2b256 hash of serialized \code{l1\_nonce}.
        \item An NFT with own policy ID and asset name of \code{l2\_id} must be minted and included in the deposit utxo.
        \item The witness staking script, instantiated with \code{l2\_id} must be registered in the transaction.
          Let the hash of this script be \code{registered\_witness}.
        \item \code{registered\_witness} must be stored in the produced deposit utxo datum under \code{witness}.
        \item The redeemer used for registering the witness script must be equal to the \code{deposit} policy ID.
        \item Let \code{deposit\_addr} be the address of the deposit contract from Midgard's hub oracle.
        \item Deposit utxo must be produced at \code{deposit\_addr}.
        \item Total number of deposited tokens (including ADA) must not exceed \code{max\_tokens\_allowed\_in\_deposits}, a protocol parameter.
        \item Recorded \code{l1\_nonce} in the deposit event must be correct.
        \item The deposit's \code{inclusion\_time} must be equal to transaction's time-validity upper bound (inclusive) plus \code{event\_wait\_duration} Midgard protocol parameter.
      \end{enumerate}
    \item[Burn Deposit NFT.] Oversee transfer of a deposit utxo to reserve by requiring its NFTs to be burnt.
    Conditions:
      \begin{enumerate}
        \item Let \code{l2\_id} be the corresponding ID of the target deposit event, provided via the redeemer.
        \item An NFT with own policy ID and asset name of \code{l2\_id} must be burnt.
        \item The witness staking script, instantiated with \code{l2\_id} must be unregistered in the transaction.
        \item The redeemer used for unregistering the witness script must be correct.
          Namely, it must be equal to \code{MintOrBurn} carrying \code{deposit} policy ID.
      \end{enumerate}
\end{description}

\subsection{Spending validator}
\label{h:deposit-spending-validator}

The \code{deposit} spending validator is statically parametrized on the \code{hub\_oracle} minting policy.
It's responsible for concluding deposits and transferring them to Midgard reserve.

\begin{description}
  \item[Spend.] Transaction for moving funds of finalized deposit events into Midgard reserve.
    Conditions:
    \begin{enumerate}
      \item Let \code{settlement} be the referenced settlement utxo.
      \item The deposit must be included in the deposit tree of \code{settlement}.
      \item Let \code{reserve\_addr} be the address of the Midgard reserve retrieved from hub oracle.
      \item The utxo produced at \code{reserve\_addr} must contain all the tokens from the deposit utxo, except for the deposit NFT.
      \item The \code{BurnEventNFT} endpoint of the deposit minting script must be invoked with the corresponding \code{l2\_id} of the deposit utxo.
      \item No datum and no reference script must be attached to the reserve utxo.
    \end{enumerate}
\end{description}

\end{document}
