\documentclass[../midgard.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\begin{document}

\section{Withdrawal event}
\label{h:withdrawal-event}

A withdrawal set is a finite map from withdrawal ID to withdrawal info:
\begin{align*}
    \T{WithdrawalSet} &\coloneq \T{Map(WithdrawalId, WithdrawalInfo)} \\
      &\coloneq \Bigl\{
        (k_i: \T{WithdrawalId}, v_i: \T{WithdrawalInfo}) \mid \forall i \neq j.\; k_i \neq k_j
    \Bigr\}
\end{align*}

A withdrawal event in a Midgard block acknowledges that a user has created an L1 utxo at the Midgard L1 withdrawal address, ordering transfer of an L2 utxo at a payment address to the L1 ledger.
\begingroup
\allowdisplaybreaks{}
\begin{align*}
    \T{WithdrawalEvent} &\coloneq \T{(WithdrawalId, WithdrawalInfo)} \\
    \T{WithdrawalId} &\coloneq \T{OutputRef} \\
    \T{WithdrawalInfo} &\coloneq \left\{
        \begin{array}{ll}
            \T{body} :& \T{WithdrawalBody} \\
            \T{signature} :& \T{(VerificationKey, Signature)} \\
            \T{validity} :& \T{WithdrawalValidity} \\
        \end{array} \right\}\\
    \T{WithdrawalBody} &\coloneq{} \left\{
        \begin{array}{ll}
            \T{l2\_outref} :& \T{OutputRef} \\
            \T{l2\_owner} :& \T{VerificationKeyHash} \\
            \T{l2\_value} :& \T{Value} \\
            \T{l1\_address} : & \T{Address} \\
            \T{l1\_datum} : & \T{CardanoDatum}
        \end{array} \right\}\\
    \T{WithdrawalValidity} \coloneq\;& \T{WithdrawalIsValid} \\
                               \mid\;& \T{NonExistentWithdrawalUtxo} \\
                               \mid\;& \T{SpentWithdrawalUtxo} \\
                               \mid\;& \T{IncorrectWithdrawalOwner} \\
                               \mid\;& \T{IncorrectWithdrawalValue} \\
                               \mid\;& \T{IncorrectWithdrawalSignature} \\
                               \mid\;& \T{TooManyTokensInWithdrawal}
\end{align*}
\endgroup

The \code{WithdrawalId} of a withdrawal event corresponds to one of the inputs spent by the user in the L1 transaction that created the L1 withdrawal request utxo (more specifically, it's the hash of its serialized output-reference).
This key is needed to identify the L1 withdrawal utxo, ensure that withdrawal events are unique, and detect when an operator has fabricated a withdrawal event without the corresponding withdrawal request existing in the L1 ledger.

If a withdrawal event is permitted by Midgard's ledger rules to be included in a block, its effect is to remove the output at output-reference \code{l2\_outref} from the block's utxo set.

Suppose the block containing the withdrawal event is confirmed, with the withdrawal event tagged as valid.
The L1 withdrawal request utxo will be sent to the \code{payout} contract, after which it can be gradually funded from the reserve.
Once fully funded, its utxo can be transfered to \code{l1\_address} with \code{l1\_datum} attached.

As observable from the \code{validity} field, withdrawal orders are optimistic in the sense that their declared information is not validated at the time of creation.
However, since inclusion of the orders is obligatory, operators can tag any invalid orders by pointing where the error is present.
Consequently, any block containing withdrawal orders that are incorrectly tagged as invalid will be considered fraudulent.

\Cref{h:withdrawal-order} describes the lifecycle of a withdrawal order in further detail.

\end{document}
